# プロジェクト概要

このファイルは、プロジェクトの全体像と現在の状態を把握するためのドキュメントです。
エージェント（AI アシスタント）や新しいプロジェクトメンバーが、最初にこのファイルを読み込むことを想定しています。

## 1. プロジェクトの目的

このプロジェクトは、単一の HTML ファイル `GBRE.html` に実装されているゲームボーイエミュレータのコードをリファクタリングし、保守性と可読性を向上させることを目的とします。

主なゴールは以下の通りです。

- HTML, CSS, JavaScript をそれぞれ適切なファイルに分割する。
- 難読化されている JavaScript コードを解析し、人間が読んで理解できるコードに修正する。

## 2. アーキテクチャ

### 現状の構成

- `GBRE.html`: すべての HTML, CSS, JavaScript コードが含まれている。

### 目指す構成

- `docs/index.html`: アプリケーションのエントリーポイント。
- `docs/css/style.css`: スタイルシート。
- `docs/js/app.js`: アプリケーションロジック。

## 3. 主要なコンポーネント

プロジェクトを構成する主要なフォルダやファイルの役割を説明します。

- `GBRE.html`: リファクタリング対象のオリジナルファイル。
- `docs/`: リファクタリング後のファイルを格納するディレクトリ。
- `agentNotes/`: リファクタリング作業に関するメモやドキュメントを格納するディレクトリ。
  - `project_overview.md` (このファイル): プロジェクトの全体像、目的、方針を記述します。 **新しい担当者はまずこのファイルを読んでください。**
  - `implementation_plan.md`: 今後の実装計画やタスク（バックログ）を管理します。作業に着手する際は、ここからタスクを取得し、ステータスを更新します。
  - `development_log.md`: 日々の開発作業や調査内容、方針決定などを時系列で記録します。 **作業内容は必ずここに追記してください（最新のものが一番上になるように）。**
  - `refactoring_log.md`: 具体的なコードの変更内容を、ファイルごと、機能ごとに記録します。
  - `coding_rules.md`: プロジェクト内でのコーディング規約を定めます。

## 4. セットアップと実行方法

`docs/index.html` を Web ブラウザで開くことでアプリケーションを実行します。

### 実行環境

- デスクトップ: Chrome, Safari
- モバイル: iPhone (Mobile Safari)

## 5. 現在の状況と次のステップ

### 現在の状況

- `GBRE.html` から `docs/index.html`, `docs/css/style.css`, `docs/js/app.js` へのコードの初期分割が完了しています。

### 開発方針と次のステップ

リファクタリングの安全性を高めるために TDD（テスト駆動開発）の導入を検討し、テスト環境の構築を試みましたが、現状のコードが密結合であるため、テストの導入がリファクタリング作業そのものを複雑化させてしまう可能性が懸念されました。

そこで、一旦 TDD の導入は見送り、まずはコードの可読性を直接向上させることに集中する方針としました。

具体的な次のステップは以下の通りです。

- `docs/js/app.js` のコードを解析し、役割が判明した変数名・関数名を、意味のわかる名前に変更する（リネーム）。
- 処理のまとまりごとにコメントを追記し、コードの意図を明確にする。

## 6. コード解析メモ

### 6.1 グローバルオブジェクト `o`

- **`o`**: エミュレータ全体の状態と機能を保持するグローバルオブジェクト。
  - **`o.m` (Memory)**: ゲームボーイのメモリ全体 (ROM, VRAM, WRAM 等) を格納する `Uint8Array`。
  - **`o.r` (Registers)**: CPU レジスタ (PC, SP, A, F, B, C, D, E, H, L 等) の値を保持する `Int32Array`。
  - **`o.ff` (Functions)**: CPU 命令やイベント処理に対応する関数の巨大な配列。 **このエミュレータの挙動を定義する中心的な要素。** (詳細は 6.2 を参照)
  - **`o.v` (Video)**: 画面描画関連のオブジェクト (`canvas`コンテキスト等)。
  - **`o.s` (Sound)**: Web Audio API を利用した音声関連のオブジェクト。
  - **`o.h`, `o.hh`, `o.b`**: 数値を 16 進数や 2 進数の文字列に変換するためのヘルパー。
  - **`o.ffrr`, `o.ffmm`**: デバッグ用にメモリやレジスタの状態を文字列化する関数。

### 6.2 関数テーブル `o.ff` 構造マップ

`o.ff` は、オペコードや特定の ID をインデックスとして、対応する処理を呼び出すための巨大な関数配列です。以下にその構造をまとめます。

| インデックス範囲  | カテゴリ                       | 説明                                                                                                                         |
| ----------------- | ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------- | ---------------------- |
| `0x00` - `0xFF`   | **CPU 基本命令**               | `NOP`, `LD`, `ADD`, `JP` など、基本的な CPU 命令セット。`0xCB` は拡張命令へのプレフィックス。                                |
| `0x100` - `0x1FF` | **CPU 拡張命令 (CB-prefixed)** | `RLC`, `BIT`, `SET`, `RES` など、`0xCB` に続けて実行される命令セット。`n                                                     | (1 << 8)` でアクセス。 |
| `0x200` - `0x2FF` | **I/O レジスタハンドラ**       | `0xFFxx` の I/O レジスタへの書き込み時に実行される特殊な処理。`p                                                             | (1 << 9)` でアクセス。 |
| `800` - `847`     | **コアロジック・ヘルパー**     | メモリバス(`800`, `801`)、セーブ/ロード(`820-822`)、ROM 解析(`831-834`)、ファイル読み込み(`844-846`)など。                   |
| `996` - `999`     | **イベントハンドラ**           | `onload`, キーボード/タッチ入力(`997`, `998`)、エミュレータ起動トリガー(`999`)など。                                         |
| `1000`            | **メインループ**               | CPU 命令実行、割り込み、タイマー、PPU/APU 更新を行うエミュレータの心臓部。`setTimeout`で再帰的に呼ばれる。                   |
| `1101` - `1177`   | **PPU / VRAM / MBC 関連**      | 描画初期化(`1101`)、スキャンライン描画(`1102`)、タイルデータデコード(`1103`)、VRAM DMA(`1106`)、MBC7 処理(`1175-1177`)など。 |
| `1200` - `1202`   | **APU (音声) 関連**            | Web Audio API の初期化(`1200`)、周波数設定(`1201`)、スイープ処理(`1202`)など。                                               |
| `1977` - `1987`   | **デバッグ表示バッファ**       | デバッグ情報をテキストエリアに表示するための一時的なデータ保持領域として使用。                                               |
| `2000` - `2018`   | **UI ボタンハンドラ**          | `Reset`(`2000`)、`Open URL`(`2001`)、`Save`(`2002`)など、画面上のボタンに対応する処理。                                      |

### 6.3 主要な処理の流れ

1.  `onload` イベントで各種 DOM 要素の生成、イベントハンドラの設定、ブートストラップ ROM(`o.ff[832]`)の読み込みが行われる。
2.  画面がクリックされると `o.ff[999]` が発火し、描画(`o.ff[1101]`)と音声(`o.ff[1200]`)の初期化が行われた後、メインループである `o.ff[1000]` が開始される。
