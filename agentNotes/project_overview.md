# プロジェクト概要

このファイルは、プロジェクトの全体像と現在の状態を把握するためのドキュメントです。
エージェント（AIアシスタント）や新しいプロジェクトメンバーが、最初にこのファイルを読み込むことを想定しています。

## 1. プロジェクトの目的

このプロジェクトは、単一のHTMLファイル `GBRE.html` に実装されているゲームボーイエミュレータのコードをリファクタリングし、保守性と可読性を向上させることを目的とします。

主なゴールは以下の通りです。
- HTML, CSS, JavaScriptをそれぞれ適切なファイルに分割する。
- 難読化されているJavaScriptコードを解析し、人間が読んで理解できるコードに修正する。

## 2. アーキテクチャ

### 現状の構成
- `GBRE.html`: すべてのHTML, CSS, JavaScriptコードが含まれている。

### 目指す構成
- `docs/index.html`: アプリケーションのエントリーポイント。
- `docs/css/style.css`: スタイルシート。
- `docs/js/app.js`: アプリケーションロジック。

## 3. 主要なコンポーネント

プロジェクトを構成する主要なフォルダやファイルの役割を説明します。

- `GBRE.html`: リファクタリング対象のオリジナルファイル。
- `docs/`: リファクタリング後のファイルを格納するディレクトリ。
- `agentNotes/`: リファクタリング作業に関するメモやドキュメントを格納するディレクトリ。
  - `project_overview.md` (このファイル): プロジェクトの全体像、目的、方針を記述します。 **新しい担当者はまずこのファイルを読んでください。**
  - `implementation_plan.md`: 今後の実装計画やタスク（バックログ）を管理します。作業に着手する際は、ここからタスクを取得し、ステータスを更新します。
  - `development_log.md`: 日々の開発作業や調査内容、方針決定などを時系列で記録します。 **作業内容は必ずここに追記してください（最新のものが一番上になるように）。**
  - `refactoring_log.md`: 具体的なコードの変更内容を、ファイルごと、機能ごとに記録します。
  - `coding_rules.md`: プロジェクト内でのコーディング規約を定めます。

## 4. セットアップと実行方法

`docs/index.html` をWebブラウザで開くことでアプリケーションを実行します。

### 実行環境
- デスクトップ: Chrome, Safari
- モバイル: iPhone (Mobile Safari)

## 5. 現在の状況と次のステップ

### 現在の状況
- `GBRE.html` から `docs/index.html`, `docs/css/style.css`, `docs/js/app.js` へのコードの初期分割が完了しています。

### 開発方針と次のステップ

リファクタリングの安全性を高めるためにTDD（テスト駆動開発）の導入を検討し、テスト環境の構築を試みましたが、現状のコードが密結合であるため、テストの導入がリファクタリング作業そのものを複雑化させてしまう可能性が懸念されました。

そこで、一旦TDDの導入は見送り、まずはコードの可読性を直接向上させることに集中する方針としました。

具体的な次のステップは以下の通りです。
- `docs/js/app.js` のコードを解析し、役割が判明した変数名・関数名を、意味のわかる名前に変更する（リネーム）。
- 処理のまとまりごとにコメントを追記し、コードの意図を明確にする。


## 6. コード解析メモ

### グローバル変数

- **`o`**: エミュレータ全体の状態と機能を保持するグローバルオブジェクト。
  - **`o.m` (Memory)**: ゲームボーイのメモリ全体 (ROM, VRAM, WRAM等) を格納する `Uint8Array`。
  - **`o.r` (Registers)**: CPUレジスタ (PC, SP, A, F, B, C, D, E, H, L等) の値を保持する `Int32Array`。
  - **`o.ff` (Functions)**: CPU命令やイベント処理に対応する関数の巨大な配列 (後述の `ff` の実体)。
  - **`o.v` (Video)**: 画面描画関連のオブジェクト (`canvas`コンテキスト等)。
  - **`o.s` (Sound)**: Web Audio APIを利用した音声関連のオブジェクト。
  - **`o.h`, `o.hh`, `o.b`**: 数値を16進数や2進数の文字列に変換するためのヘルパー。
  - **`o.ffrr`, `o.ffmm`**: デバッグ用にメモリやレジスタの状態を文字列化する関数。

- **`ff`**: `o.ff` のエイリアス。実質的にCPUそのものとして機能する。
  - **CPU命令ディスパッチテーブル**: メモリから読み込んだオペコードをインデックスとして、対応する関数を `ff` 配列から呼び出して実行する。
    - 例: `ff[0x00]` は `NOP` 命令、 `ff[0xc3]` は `JP nn` 命令。
  - **拡張命令セット**: `ff[0xcb]` が呼ばれると、続く1バイトを元に `ff[n | 1 << 8]` を実行し、CBプリフィックス命令を処理する。
  - **I/O・イベントハンドラ**: CPU命令以外にも、特定のインデックスにはDOMイベントやファイルI/Oの処理が割り当てられている。
    - 例: `ff[999]` (画面クリック)、`ff[1999]` (ボタンクリック)。

### 主要な処理の流れ

1.  `onload` イベントで各種DOM要素の生成、イベントハンドラの設定、ブートストラップROM(`o.ff[832]`)の読み込みが行われる。
2.  画面がクリックされると `o.ff[999]` が発火し、描画(`o.ff[1101]`)と音声(`o.ff[1200]`)の初期化が行われた後、メインループである `o.ff[1000]` が開始される。
3.  `o.ff[1000]` は `setTimeout` によって定期的に実行され、CPUのクロックを進め、命令を1つずつフェッチ・デコード・実行(`ffn`)し、各種ハードウェア（タイマー、PPU、APU）の状態を更新する。
